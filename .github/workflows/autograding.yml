name: Autograding with Google Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  autograde:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libgtest-dev xmlstarlet

      - name: Configure
        run: cmake -S . -B build

      - name: Build
        run: cmake --build build -- -j$(nproc)

      # ─── AUTOGRADER RUNNER ───────────────────────
      - name: Run Google Tests
        id: tests
        run: |
          ./build/tests/CPP_AUTOGRADED \
            --gtest_output=xml:build/results.xml || true

      # ─── GENERATE CLASSROOM JSON ─────────────────
      - name: Generate autograding results
        run: |
          cd build

          declare -A TEST_POINTS=(
            ["SumUpToTest.PositiveNumbers"]=60
            ["SumUpToTest.EdgeCases"]=40
          )

          echo '{ "tests": [' > results.json
          FIRST=true

          for TEST in "${!TEST_POINTS[@]}"; do
            CLASS="${TEST%%.*}"
            NAME="${TEST#*.}"
            POINTS=${TEST_POINTS[$TEST]}

            FAILED=$(xmlstarlet sel \
              -t -v "count(//testcase[@classname='$CLASS' and @name='$NAME']/failure)" \
              results.xml)

            if [ "$FAILED" -eq 0 ]; then
              STATUS="passed"
              SCORE=$POINTS
            else
              STATUS="failed"
              SCORE=0
            fi

            if [ "$FIRST" = false ]; then
              echo ',' >> results.json
            fi
            FIRST=false

            printf '{ "name": "%s", "status": "%s", "score": %d, "max_score": %d }' \
              "$TEST" "$STATUS" "$SCORE" "$POINTS" >> results.json
          done

          echo '] }' >> results.json

      # ─── REPORT TO CLASSROOM ─────────────────────
      - name: Autograding Reporter
        uses: classroom-resources/autograding-grading-reporter@v1
        with:
          runners: tests
          results-path: build/results.json
